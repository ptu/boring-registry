name: Minio

on:
  push:
    branches: [ main, minio-tests ]
  pull_request:
    branches: [ main ]

jobs:
  minio:
    name: minio
    runs-on: ubuntu-latest
    services:
      minio:
        image: minio/minio
        ports:
          - 9000:9000
        env:
          MINIO_ACCESS_KEY: citest
          MINIO_SECRET_KEY: citest
        volumes:
          - ${{ github.workspace }}/data:/data
        options: --name=minio --health-cmd "curl http://localhost:9000/minio/health/live"
        command: server /data
    steps:
      - name: Install minio python module
        run: pip3 install minio
      - name: Setup minio bucket
        run: |
            python3 - <<'EOF'
            from minio import Minio
            from minio.error import InvalidResponseError

            try:
                minio = Minio(
                    'localhost:9000',
                    access_key='${{ env.MINIO_ACCESS_KEY }}',
                    secret_key='${{ env.MINIO_SECRET_KEY }}',
                    secure=False
                )
            except Exception as ex:
                raise

            minio.make_bucket('foo')
            minio.make_bucket('bar')
            print(f'{minio.list_buckets()}')
            EOF